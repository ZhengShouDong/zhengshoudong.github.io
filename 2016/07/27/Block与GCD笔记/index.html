<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>Block与GCD笔记 | ZhengShouDong_Blog|郑守栋博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Block与GCD笔记1.定义block:
12345第一种：（直接写）@property (copy) void(^MyBlock)(void);			第二种：（typedef）typedef void(^MyBlock)(void);@property (nonatomic, copy) MyBlock block;">
<meta property="og:type" content="article">
<meta property="og:title" content="Block与GCD笔记">
<meta property="og:url" content="https://zhengshoudong.github.io/2016/07/27/Block与GCD笔记/index.html">
<meta property="og:site_name" content="ZhengShouDong_Blog|郑守栋博客">
<meta property="og:description" content="Block与GCD笔记1.定义block:
12345第一种：（直接写）@property (copy) void(^MyBlock)(void);			第二种：（typedef）typedef void(^MyBlock)(void);@property (nonatomic, copy) MyBlock block;">
<meta property="og:updated_time" content="2016-08-16T03:59:55.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Block与GCD笔记">
<meta name="twitter:description" content="Block与GCD笔记1.定义block:
12345第一种：（直接写）@property (copy) void(^MyBlock)(void);			第二种：（typedef）typedef void(^MyBlock)(void);@property (nonatomic, copy) MyBlock block;">
  
  
  <link rel="stylesheet" href="/css/style.css">
  <meta name="baidu-site-verification" content="esqrnqpKhj" />
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="undefined" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">ZhengShouDong</a></h1>
		</hgroup>

		
		<p class="header-subtitle">🌀</p>
		

		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
						</div>
					</nav>
				</section>
				
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">ZhengShouDong</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img src="undefined" class="js-avatar" style="width: 100%;height: 100%;opacity: 1;">
			
			</div>
			<hgroup>
			  <h1 class="header-author">ZhengShouDong</h1>
			</hgroup>
			
			<p class="header-subtitle">🌀</p>
			
			<nav class="header-menu">
				<ul>
				
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-Block与GCD笔记" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/27/Block与GCD笔记/" class="article-date">
  	<time datetime="2016-07-27T03:15:05.000Z" itemprop="datePublished">2016-07-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Block与GCD笔记
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/iOS开发笔记/">-iOS开发笔记</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Block与GCD笔记"><a href="#Block与GCD笔记" class="headerlink" title="Block与GCD笔记"></a>Block与GCD笔记</h1><p>1.定义block:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">第一种：（直接写）</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">copy</span>) <span class="keyword">void</span>(^MyBlock)(<span class="keyword">void</span>);			</div><div class="line">第二种：（<span class="keyword">typedef</span>）</div><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span>(^MyBlock)(<span class="keyword">void</span>);</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) MyBlock block;</div></pre></td></tr></table></figure>
<a id="more"></a>
<h4 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h4><p>Block语法</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">^ 返回值类型 参数列表 表达式</div><div class="line">^ 参数列表 表达式 <span class="comment">(省略返回值类型)</span></div><div class="line">^ 表达式 （省略参数列表）</div></pre></td></tr></table></figure>
<h4 id="Block变量类型"><a href="#Block变量类型" class="headerlink" title="Block变量类型"></a>Block变量类型</h4><p>自动变量： 返回值类型 (^类型名称)(参数列表)</p>
<p>函数参数： 返回值类型 (^类型名称)(参数列表) 返回值参数： ^类型名称()（参数列表） 使用typedef 更方便</p>
<h4 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h4><ul>
<li>当 block 调用 copy 方法时，如果 block 在栈上，会被拷贝到堆上；</li>
<li>当 block 作为函数返回值返回时，编译器自动将 block 作为 _Block_copy 函数，效果等同于 block 直接调用 copy 方法；</li>
<li>当 block 被赋值给 __strong id 类型的对象或 block 的成员变量时，编译器自动将 block 作为 _Block_copy 函数，效果等同于 block 直接调用 copy 方法；</li>
<li>当 block 作为参数被传入方法名带有 usingBlock 的 Cocoa Framework 方法或 GCD 的 API 时。这些方法会在内部对传递进来的 block 调用 copy 或 _Block_copy 进行拷贝;</li>
</ul>
<h4 id="Block强引用的解决"><a href="#Block强引用的解决" class="headerlink" title="Block强引用的解决"></a>Block强引用的解决</h4><ul>
<li>1.在block里面不用使用self，解决方案：推荐 __weak typeof(self) weakSelf = self(弱引用);</li>
<li>2.强引用bug<br>如果你发现你的控制器pop后任然不会销毁，可能是你在block中使用了self从而强引用了控制器。</li>
<li>3.但不是所有的block里面就需要处理里面的变量，因为有的block声明周期就很短，执行完后就不存在了就不用处理，如UIView的动画。</li>
<li>4.为了方便以后使用我们可以将 __weak typeof(self) weakSelf = self语句抽取为宏</li>
</ul>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 宏抽取</span></div><div class="line">#define JPWeakSelf  __weak typeof(<span class="built_in">self</span>) weakSelf = <span class="built_in">self</span>; <span class="comment">// (弱引用)</span></div></pre></td></tr></table></figure>
<h4 id="Block可以访问局部变量，但是不能修改它的值；如果要修改的话该变量必须用-block修饰；"><a href="#Block可以访问局部变量，但是不能修改它的值；如果要修改的话该变量必须用-block修饰；" class="headerlink" title="Block可以访问局部变量，但是不能修改它的值；如果要修改的话该变量必须用__block修饰；"></a>Block可以访问局部变量，但是不能修改它的值；如果要修改的话该变量必须用__block修饰；</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> a = <span class="number">10</span>； <span class="keyword">void</span>(^BlockName)() = ^&#123;  a++;  &#125;;</div></pre></td></tr></table></figure>
<p>此处a的值不能修改;</p>
<p>原因：此处不能修改的原因是在编译期间确定的，编译器编译的时候把a的值复制到block作为一个新变量（假设是a‘ = 10），此时a’和a是没有关系的</p>
<h4 id="如果block块里边有self这样的代码，-self必须用-weak-修饰；"><a href="#如果block块里边有self这样的代码，-self必须用-weak-修饰；" class="headerlink" title="如果block块里边有self这样的代码， self必须用__weak 修饰；"></a>如果block块里边有self这样的代码， self必须用__weak 修饰；</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">__<span class="keyword">self</span> ViewController *controller = <span class="keyword">self</span>;</div><div class="line"><span class="keyword">void</span>(^BlockName)() = ^&#123;  <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, controller.string); &#125;;</div></pre></td></tr></table></figure>
<p>原因：block会对内部的对象进行一次retain，也就是说self会被retain一次。当self释放的时候，需要block释放后才会对self进行释放，但是block的释放又需要等self的dealloc中才会释放。如此一来变形成了循环引用，导致内存泄露。（一句话防止循环引用）</p>
<h4 id="在申明block属性的时候用copy-后者strong修饰；"><a href="#在申明block属性的时候用copy-后者strong修饰；" class="headerlink" title="在申明block属性的时候用copy 后者strong修饰；"></a>在申明block属性的时候用copy 后者strong修饰；</h4><p>因为默认情况下，block是存档在栈中，可能被随时回收，需要copy到堆区一份，防止被释放掉；<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@<span class="keyword">property</span>（<span class="keyword">copy</span>，<span class="keyword">nonatomic</span>）<span class="keyword">BlockName</span>  myBlock；</div></pre></td></tr></table></figure></p>
<h4 id="在多线程环境下（block中的weakSelf有可能被析构的情况下），需要先将self转为strong指针，避免在运行到某个关键步骤时self对象被析构"><a href="#在多线程环境下（block中的weakSelf有可能被析构的情况下），需要先将self转为strong指针，避免在运行到某个关键步骤时self对象被析构" class="headerlink" title="在多线程环境下（block中的weakSelf有可能被析构的情况下），需要先将self转为strong指针，避免在运行到某个关键步骤时self对象被析构;"></a>在多线程环境下（block中的weakSelf有可能被析构的情况下），需要先将self转为strong指针，避免在运行到某个关键步骤时self对象被析构;</h4><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">__<span class="keyword">weak</span> __<span class="keyword">typeof</span>(<span class="keyword">self</span>)weakSelf =<span class="keyword">self</span>;</div><div class="line">AFNetworkReachabilityStatusBlock callback= ^(AFNetworkReachabilityStatus status) &#123;</div><div class="line">		__<span class="keyword">strong</span> __<span class="keyword">typeof</span>(weakSelf)strongSelf=weakSelf;</div><div class="line">	strongSelf.networkReachabilityStatus=status;<span class="keyword">if</span>(strongSelf.networkReachabilityStatusBlock) &#123;</div><div class="line">	strongSelf.networkReachabilityStatusBlock(status);</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<hr>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/07/27/iOS-UI面试题目与答案整理/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          iOS_UI面试题目与答案整理
        
      </div>
    </a>
  
  
    <a href="/2016/07/26/转移博客中/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">转移博客中</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>








</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    	</div>
      <div class="footer-center">
      &copy; 2016 ZhengShouDong<br>
          <a href="http://www.zhengshoudong.cn/" target="_blank">ZHENGSHOUDONG</a><br>
          <a href="/sitemap.xml" target="_blank">sitemap</a>
      </div>
      	<div class="footer-right">
        <!--下方网页统计代码嵌入-->
        <script src="https://s4.cnzz.com/z_stat.php?id=1260045528&web_id=1260045528" language="JavaScript"></script>
      	</div>
    </div>
  </div>
</footer>
    </div>
    

<script>
	var yiliaConfig = {
		fancybox: undefined,
		mathjax: undefined,
		animate: undefined,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: undefined
	}
</script>
<script src="/js/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






  </div>
</body>
</html>